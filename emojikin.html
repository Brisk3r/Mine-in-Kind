<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EmojiKin Nexus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }
        .stat-icon {
            font-size: 1.25rem;
        }
        .emoji-kin {
            font-size: 5rem;
            line-height: 1;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4b5563; }
        
        /* Nav button style */
        .nav-btn.active {
            background-color: #06b6d4;
            color: white;
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.5);
        }

        /* Generation Animation Styles */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(6, 182, 212, 0.5); transform: scale(1); }
            50% { box-shadow: 0 0 35px rgba(6, 182, 212, 0.9); transform: scale(1.05); }
        }
        .animate-pulse-glow {
            animation: pulse-glow 2s infinite ease-in-out;
        }
        @keyframes scale-in {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .animate-scale-in {
            animation: scale-in 0.5s cubic-bezier(0.250, 0.460, 0.450, 0.940) both;
        }

        /* Training Progress Bar Animation */
        @keyframes progress-countdown {
            from { width: 100%; }
            to { width: 0%; }
        }
        .progress-bar-inner {
            animation-name: progress-countdown;
            animation-timing-function: linear;
        }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased flex items-center justify-center min-h-screen p-4">

    <!-- Player Creation Overlay -->
    <div id="player-creation-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-95 z-50 flex-col items-center justify-center text-center p-4 hidden">
        <h2 class="text-3xl font-orbitron font-semibold mb-4 text-white">Welcome to the Nexus</h2>
        <p class="text-gray-400 max-w-md mb-6">Please create your player name to begin.</p>
        <div class="flex items-center gap-2 w-full max-w-xs">
            <input type="text" id="player-name-input" placeholder="Enter your name" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
            <button id="create-player-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-5 rounded-lg transition duration-300">Create</button>
        </div>
    </div>

    <!-- Digivice Container -->
    <div id="digivice-container" class="w-full max-w-5xl h-[80vh] min-h-[600px] bg-gray-800 rounded-3xl shadow-2xl border-4 border-gray-700 flex-col md:flex-row overflow-hidden hidden">

        <!-- Sidebar Menu -->
        <nav id="sidebar" class="w-full md:w-1/4 bg-gray-900 p-6 flex flex-row md:flex-col justify-around md:justify-start md:space-y-6 border-t-4 md:border-t-0 md:border-r-4 border-gray-700">
            <div class="text-center mb-4">
                <h1 class="text-2xl font-orbitron font-bold text-cyan-400">NEXUS</h1>
                <p class="text-md text-white mt-2 font-semibold" id="player-name-display"></p>
            </div>
            <button class="nav-btn active flex-grow md:flex-grow-0" data-screen="habitat">
                <span class="text-2xl">üè†</span> <span class="hidden md:inline">Habitat</span>
            </button>
            <button class="nav-btn" data-screen="nexus">
                <span class="text-2xl">üñãÔ∏è</span> <span class="hidden md:inline">Nexus</span>
            </button>
            <button class="nav-btn" data-screen="lab">
                <span class="text-2xl">üî¨</span> <span class="hidden md:inline">Lab</span>
            </button>
        </nav>

        <!-- Main Screen -->
        <main id="main-screen" class="flex-grow bg-gray-800 p-6 flex flex-col relative overflow-y-auto">
            <!-- Loading State -->
            <div id="loading-state" class="absolute inset-0 flex flex-col text-center items-center justify-center bg-gray-800 z-10">
                <p class="text-lg text-gray-400 font-orbitron animate-pulse">CONNECTING...</p>
            </div>

            <!-- Habitat Screen -->
            <div id="screen-habitat" class="screen flex-grow flex flex-col">
                <h2 class="text-3xl font-orbitron font-semibold mb-4 text-white">Habitat</h2>
                <div id="habitat-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 flex-grow">
                     <div id="no-kin-message" class="col-span-full text-center py-10 text-gray-500 flex flex-col items-center justify-center">
                        <p class="text-4xl mb-4">ÌÖÖ ÎπÑÎã§</p><p>Your habitat is empty.</p><p class="text-sm text-gray-600">Use the Nexus to generate an EmojiKin.</p>
                    </div>
                </div>
            </div>

            <!-- Nexus Screen -->
            <div id="screen-nexus" class="screen hidden flex-grow flex flex-col items-center justify-center text-center">
                <div id="nexus-form">
                    <h2 class="text-3xl font-orbitron font-semibold mb-4 text-white">Nexus Font</h2>
                    <p class="text-gray-400 max-w-md mb-6">A unique phrase acts as the digital DNA. Discover new combinations to generate rare EmojiKin.</p>
                    <div class="flex items-center gap-2 w-full max-w-sm">
                        <input type="text" id="glyph-input" placeholder="'cosmic power' or 'üåä‚òÄÔ∏è'" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
                        <button id="generate-btn" class="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-md">Generate</button>
                    </div>
                </div>
                <div id="nexus-generation" class="hidden w-full max-w-sm">
                    <div id="nexus-animation" class="text-center">
                        <p class="font-orbitron text-cyan-400 mb-4">ANALYZING GLYPH...</p>
                        <div class="w-24 h-24 bg-gray-900 border-4 border-cyan-500 rounded-full mx-auto flex items-center justify-center animate-pulse-glow"><span class="text-4xl">üß¨</span></div>
                    </div>
                    <div id="nexus-reveal" class="hidden text-center">
                        <h2 class="text-2xl font-orbitron font-semibold mb-4 text-white">New EmojiKin Found!</h2>
                        <div id="reveal-emoji" class="text-8xl mb-4 animate-scale-in"></div>
                        <div class="bg-gray-700 rounded-lg p-4 mb-4">
                            <h3 class="text-lg font-bold mb-2">Base Stats</h3>
                            <div id="reveal-stats" class="flex justify-around text-gray-300"></div>
                        </div>
                        <div class="flex flex-col gap-2">
                             <input type="text" id="nickname-input" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white text-center focus:outline-none focus:ring-2 focus:ring-cyan-500 transition">
                             <button id="confirm-kin-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition duration-300">Confirm & Name</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Lab Screen -->
            <div id="screen-lab" class="screen hidden flex-grow flex flex-col items-center justify-center text-center">
                <h2 class="text-3xl font-orbitron font-semibold mb-4 text-white">Breeding Lab</h2>
                <p class="text-gray-400">This feature is under development.</p>
                <p class="text-sm text-gray-600 mt-2">Combine two EmojiKin to create a new generation.</p>
            </div>
        </main>
    </div>

    <!-- Training Modal -->
    <div id="training-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-md border border-gray-700">
            <h3 class="text-2xl font-bold mb-2 text-white">Train <span id="modal-kin-name"></span> <span id="modal-kin-emoji"></span></h3>
            <p class="text-gray-400 mb-6">Select a stat to improve. Training takes time.</p>
            <div class="space-y-4">
                <button data-stat="atk" data-duration="30" class="training-option w-full text-left flex items-center justify-between p-4 bg-gray-700 hover:bg-gray-600 rounded-lg transition"><div><p class="font-semibold"><span class="stat-icon">‚öîÔ∏è</span> Attack</p><p class="text-sm text-gray-400">30s</p></div><span class="text-lg font-bold text-red-400">+5</span></button>
                <button data-stat="def" data-duration="60" class="training-option w-full text-left flex items-center justify-between p-4 bg-gray-700 hover:bg-gray-600 rounded-lg transition"><div><p class="font-semibold"><span class="stat-icon">üõ°Ô∏è</span> Defense</p><p class="text-sm text-gray-400">1m</p></div><span class="text-lg font-bold text-blue-400">+5</span></button>
                <button data-stat="spd" data-duration="120" class="training-option w-full text-left flex items-center justify-between p-4 bg-gray-700 hover:bg-gray-600 rounded-lg transition"><div><p class="font-semibold"><span class="stat-icon">üí®</span> Speed</p><p class="text-sm text-gray-400">2m</p></div><span class="text-lg font-bold text-green-400">+5</span></button>
            </div>
            <button id="close-modal-btn" class="mt-6 w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition">Cancel</button>
        </div>
    </div>
    
    <div id="message-box" class="fixed bottom-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg text-sm opacity-0 translate-y-4 transition-all duration-500 z-50"></div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, addDoc, serverTimestamp, updateDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Your Web App's Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCtNbE5ajxLdc57G5y3Wq9bz7ZgP4bgiEE",
            authDomain: "gamedb-903e3.firebaseapp.com",
            projectId: "gamedb-903e3",
            storageBucket: "gamedb-903e3.appspot.com",
            messagingSenderId: "307571396357",
            appId: "1:307571396357:web:b06907586d7b311532316c",
            measurementId: "G-C4K1SVED60"
        };

        // --- App Variables ---
        let app, db, auth, userId, playerName;
        let localKinCache = [];
        let trainingTimers = {};
        let tempKinData = null;

        // --- DOM Elements ---
        const playerCreationOverlay = document.getElementById('player-creation-overlay');
        const playerNameInput = document.getElementById('player-name-input');
        const createPlayerBtn = document.getElementById('create-player-btn');
        const digiviceContainer = document.getElementById('digivice-container');
        const loadingState = document.getElementById('loading-state');
        const playerNameDisplay = document.getElementById('player-name-display');
        const habitatGrid = document.getElementById('habitat-grid');
        const noKinMessage = document.getElementById('no-kin-message');
        const navButtons = document.querySelectorAll('.nav-btn');
        const screens = document.querySelectorAll('.screen');
        const messageBox = document.getElementById('message-box');
        const nexusForm = document.getElementById('nexus-form');
        const nexusGeneration = document.getElementById('nexus-generation');
        const nexusAnimation = document.getElementById('nexus-animation');
        const nexusReveal = document.getElementById('nexus-reveal');
        const glyphInput = document.getElementById('glyph-input');
        const generateBtn = document.getElementById('generate-btn');
        const revealEmoji = document.getElementById('reveal-emoji');
        const revealStats = document.getElementById('reveal-stats');
        const nicknameInput = document.getElementById('nickname-input');
        const confirmKinBtn = document.getElementById('confirm-kin-btn');
        const trainingModal = document.getElementById('training-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalKinName = document.getElementById('modal-kin-name');
        const modalKinEmoji = document.getElementById('modal-kin-emoji');

        // --- Core Application Logic ---

        async function initializeFirebase() {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // **FIX:** Explicitly set persistence to local storage
            try {
                await setPersistence(auth, browserLocalPersistence);
            } catch (error) {
                console.error("Error setting persistence:", error);
            }
            
            setupAuthListener();
        }

        function setupAuthListener() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    // Check if this user has a profile (player name)
                    const userProfileRef = doc(db, "users", userId);
                    const userProfileSnap = await getDoc(userProfileRef);

                    if (userProfileSnap.exists()) {
                        // Existing user, load their data
                        playerName = userProfileSnap.data().playerName;
                        showGame();
                    } else {
                        // New user, show the creation screen
                        loadingState.style.display = 'none';
                        playerCreationOverlay.classList.remove('hidden');
                        playerCreationOverlay.classList.add('flex');
                    }
                } else {
                    await signInAnonymously(auth).catch(error => {
                        console.error("Anonymous sign-in failed:", error);
                        loadingState.innerHTML = `<p class="text-red-400">Authentication Failed. Ensure Anonymous sign-in is enabled in your Firebase project.</p>`;
                    });
                }
            });
        }

        async function handleCreatePlayer() {
            const name = playerNameInput.value.trim();
            if (!name) {
                showMessage("Player name cannot be empty.", "error");
                return;
            }
            playerName = name;
            
            // Save the player name to their user profile
            const userProfileRef = doc(db, "users", userId);
            await setDoc(userProfileRef, { playerName: playerName, createdAt: serverTimestamp() });

            playerCreationOverlay.classList.add('hidden');
            playerCreationOverlay.classList.remove('flex');
            showGame();
        }

        async function showGame() {
            playerNameDisplay.textContent = playerName;
            digiviceContainer.classList.remove('hidden');
            digiviceContainer.classList.add('flex');
            loadingState.style.display = 'none';
            await setupRealtimeListener();
        }

        async function setupRealtimeListener() {
            if (!userId) return;
            const kinCollectionPath = `apps/emojikin-nexus/users/${userId}/emojikin`;
            onSnapshot(collection(db, kinCollectionPath), (snapshot) => {
                localKinCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderHabitat();
                checkTrainingCompletions();
            }, (error) => {
                console.error("Firestore listener error:", error);
                if (error.code === 'permission-denied') {
                    showMessage("Error: Check your Firestore rules.", "error");
                }
            });
        }

        function renderHabitat() {
            habitatGrid.innerHTML = ''; 
            if (localKinCache.length === 0) {
                 habitatGrid.appendChild(noKinMessage);
            } else {
                localKinCache.forEach(kin => habitatGrid.appendChild(createKinCard(kin)));
            }
        }
        
        function createKinCard(kin) {
            const card = document.createElement('div');
            card.className = 'bg-gray-700 p-5 rounded-xl shadow-lg flex flex-col items-center text-center border border-gray-600 transition transform hover:-translate-y-1';
            const isTraining = kin.is_training;
            const trainingEnds = kin.training_ends_at?.toDate();
            const now = new Date();
            let statusHTML;
            if (isTraining && trainingEnds > now) {
                const remainingTime = Math.max(0, Math.round((trainingEnds - now) / 1000));
                statusHTML = `
                    <div class="w-full text-center">
                        <p class="text-sm text-yellow-400">Training ${kin.training_stat.toUpperCase()}...</p>
                        <p id="timer-${kin.id}" class="text-lg font-mono font-bold">${formatTime(remainingTime)}</p>
                        <div class="w-full bg-gray-600 rounded-full h-2.5 mt-2">
                            <div id="progress-${kin.id}" class="bg-yellow-400 h-2.5 rounded-full progress-bar-inner" style="animation-duration: ${kin.training_duration}s;"></div>
                        </div>
                    </div>`;
                startClientTimer(kin.id, remainingTime, kin.training_duration);
            } else {
                 statusHTML = `<button data-kin-id="${kin.id}" class="train-btn mt-4 w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Train</button>`;
            }
            card.innerHTML = `
                <div class="emoji-kin mb-3">${kin.base_emoji}</div>
                <h3 class="text-xl font-bold text-white">${kin.nickname}</h3>
                <div class="flex justify-center gap-4 my-3 text-gray-300">
                    <div title="Health"><span class="stat-icon">‚ù§Ô∏è</span> <span class="font-mono">${kin.stats.hp}</span></div>
                    <div title="Attack"><span class="stat-icon">‚öîÔ∏è</span> <span class="font-mono">${kin.stats.atk}</span></div>
                    <div title="Defense"><span class="stat-icon">üõ°Ô∏è</span> <span class="font-mono">${kin.stats.def}</span></div>
                    <div title="Speed"><span class="stat-icon">üí®</span> <span class="font-mono">${kin.stats.spd}</span></div>
                </div>
                <div class="w-full mt-auto pt-3 border-t border-gray-600">${statusHTML}</div>`;
            return card;
        }
        
        function startClientTimer(kinId, remainingSeconds, totalDuration) {
            if (trainingTimers[kinId]) clearInterval(trainingTimers[kinId]);
            const timerElement = document.getElementById(`timer-${kinId}`);
            const progressBar = document.getElementById(`progress-${kinId}`);
            if (!timerElement || !progressBar) return;
            const initialProgress = (remainingSeconds / totalDuration) * 100;
            progressBar.style.width = `${initialProgress}%`;
            progressBar.classList.remove('progress-bar-inner');
            void progressBar.offsetWidth;
            progressBar.classList.add('progress-bar-inner');
            progressBar.style.animationDuration = `${remainingSeconds}s`;
            let seconds = remainingSeconds;
            trainingTimers[kinId] = setInterval(() => {
                seconds--;
                if (seconds >= 0) {
                    timerElement.textContent = formatTime(seconds);
                } else {
                    clearInterval(trainingTimers[kinId]);
                    timerElement.textContent = "Complete!";
                }
            }, 1000);
        }

        async function checkTrainingCompletions() {
            const now = new Date();
            for (const kin of localKinCache) {
                if (kin.is_training && kin.training_ends_at?.toDate() < now) {
                    await completeTraining(kin);
                }
            }
        }

        async function completeTraining(kin) {
            const kinDocRef = doc(db, `apps/emojikin-nexus/users/${userId}/emojikin`, kin.id);
            const newStats = { ...kin.stats };
            const statToUpgrade = kin.training_stat;
            if (statToUpgrade in newStats) newStats[statToUpgrade] += 5;
            try {
                await updateDoc(kinDocRef, { 
                    stats: newStats, is_training: false, training_stat: null, 
                    training_ends_at: null, training_duration: null
                });
                showMessage(`${kin.nickname} finished training!`, 'success');
            } catch (error) { console.error("Error completing training:", error); }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            return `${mins}:${secs}`;
        }

        function handleGenerateKin() {
            const input = glyphInput.value.trim();
            if (!input) { showMessage("Please enter a phrase or emoji.", "error"); return; }
            
            nexusForm.classList.add('hidden');
            nexusGeneration.classList.remove('hidden');
            nexusAnimation.classList.remove('hidden');
            nexusReveal.classList.add('hidden');
            generateBtn.disabled = true;

            setTimeout(() => {
                let hash = 0;
                for (let i = 0; i < input.length; i++) hash = input.charCodeAt(i) + ((hash << 5) - hash);
                const emojis = ['üêâ', 'ü¶Ñ', 'üëª', 'üêô', 'ü§ñ', 'ü¶ä', 'ü¶Å', 'üê∏', 'ü¶â', 'ü¶ñ', 'üê≥', 'ü¶Ä'];
                const nicknames = ['Sparky', 'Rocky', 'Bubbles', 'Bolt', 'Glimmer', 'Fang', 'Shell', 'Dash', 'Terra', 'Aqua'];
                tempKinData = {
                    base_emoji: emojis[Math.abs(hash) % emojis.length],
                    nickname: nicknames[Math.abs(hash) % nicknames.length],
                    stats: {
                        hp: 50 + (Math.abs(hash) % 20), atk: 10 + (Math.abs(hash >> 2) % 10),
                        def: 10 + (Math.abs(hash >> 4) % 10), spd: 10 + (Math.abs(hash >> 6) % 10),
                    },
                };
                revealEmoji.textContent = tempKinData.base_emoji;
                revealStats.innerHTML = `
                    <div><span class="stat-icon">‚ù§Ô∏è</span> ${tempKinData.stats.hp}</div>
                    <div><span class="stat-icon">‚öîÔ∏è</span> ${tempKinData.stats.atk}</div>
                    <div><span class="stat-icon">üõ°Ô∏è</span> ${tempKinData.stats.def}</div>
                    <div><span class="stat-icon">üí®</span> ${tempKinData.stats.spd}</div>`;
                nicknameInput.value = tempKinData.nickname;
                nexusAnimation.classList.add('hidden');
                nexusReveal.classList.remove('hidden');
            }, 2500);
        }

        async function handleConfirmKin() {
            const finalNickname = nicknameInput.value.trim();
            if (!finalNickname) { showMessage("Nickname cannot be empty.", "error"); return; }
            confirmKinBtn.disabled = true;
            confirmKinBtn.textContent = 'Saving...';
            const newKin = {
                ...tempKinData, nickname: finalNickname, owner_id: userId,
                is_training: false, training_stat: null, training_ends_at: null,
                training_duration: null, createdAt: serverTimestamp()
            };
            try {
                const kinCollectionPath = `apps/emojikin-nexus/users/${userId}/emojikin`;
                await addDoc(collection(db, kinCollectionPath), newKin);
                showMessage(`${newKin.nickname} ${newKin.base_emoji} has joined your habitat!`, 'success');
                resetNexusScreen();
                showScreen('habitat');
            } catch (error) {
                console.error("Error saving Kin:", error);
                showMessage("Failed to save EmojiKin.", "error");
            } finally {
                confirmKinBtn.disabled = false;
                confirmKinBtn.textContent = 'Confirm & Name';
            }
        }
        
        function resetNexusScreen() {
            glyphInput.value = '';
            nexusForm.classList.remove('hidden');
            nexusGeneration.classList.add('hidden');
            generateBtn.disabled = false;
            tempKinData = null;
        }

        async function handleStartTraining(kinId, stat, durationInSeconds) {
            const kin = localKinCache.find(k => k.id === kinId);
            if (!kin || kin.is_training) return;
            const trainingEndTime = new Date(Date.now() + durationInSeconds * 1000);
            const kinDocRef = doc(db, `apps/emojikin-nexus/users/${userId}/emojikin`, kinId);
            try {
                await updateDoc(kinDocRef, { 
                    is_training: true, training_stat: stat, training_ends_at: trainingEndTime,
                    training_duration: durationInSeconds 
                });
                showMessage(`${kin.nickname} started training!`, 'success');
                closeTrainingModal();
            } catch (error) { console.error("Error starting training:", error); }
        }
        
        function showMessage(text, type = 'success') {
            messageBox.textContent = text;
            messageBox.className = 'fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg text-sm transition-all duration-500 z-50';
            messageBox.classList.add(type === 'success' ? 'bg-green-500' : 'bg-red-500', 'opacity-100', 'translate-y-0');
            setTimeout(() => {
                messageBox.classList.remove('opacity-100', 'translate-y-0');
                messageBox.classList.add('opacity-0', 'translate-y-4');
            }, 3000);
        }

        function showScreen(screenId) {
            screens.forEach(screen => screen.classList.add('hidden'));
            navButtons.forEach(btn => btn.classList.remove('active'));
            document.getElementById(`screen-${screenId}`).classList.remove('hidden');
            document.querySelector(`.nav-btn[data-screen="${screenId}"]`).classList.add('active');
            if(screenId === 'nexus') resetNexusScreen();
        }

        navButtons.forEach(btn => {
            btn.addEventListener('click', () => showScreen(btn.dataset.screen));
            btn.classList.add('w-full', 'text-gray-300', 'hover:bg-cyan-600', 'font-bold', 'py-3', 'px-4', 'rounded-lg', 'transition', 'duration-300', 'flex', 'items-center', 'justify-center', 'md:justify-start', 'gap-4');
        });

        let currentTrainingKinId = null;
        function openTrainingModal(kinId) {
            currentTrainingKinId = kinId;
            const kin = localKinCache.find(k => k.id === kinId);
            if (kin) {
                modalKinName.textContent = kin.nickname;
                modalKinEmoji.textContent = kin.base_emoji;
                trainingModal.classList.remove('hidden');
            }
        }
        function closeTrainingModal() {
            currentTrainingKinId = null;
            trainingModal.classList.add('hidden');
        }

        // --- Event Listeners ---
        createPlayerBtn.addEventListener('click', handleCreatePlayer);
        playerNameInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleCreatePlayer(); });
        generateBtn.addEventListener('click', handleGenerateKin);
        confirmKinBtn.addEventListener('click', handleConfirmKin);
        glyphInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleGenerateKin(); });
        closeModalBtn.addEventListener('click', closeTrainingModal);
        document.body.addEventListener('click', (e) => {
            const trainBtn = e.target.closest('.train-btn');
            if (trainBtn) openTrainingModal(trainBtn.dataset.kinId);
            
            const trainingOption = e.target.closest('.training-option');
            if (trainingOption && currentTrainingKinId) {
                handleStartTraining(currentTrainingKinId, trainingOption.dataset.stat, parseInt(trainingOption.dataset.duration, 10));
            }
        });
        
        setInterval(checkTrainingCompletions, 5000);

        // --- Start the App ---
        initializeFirebase();
    </script>
</body>
</html>
